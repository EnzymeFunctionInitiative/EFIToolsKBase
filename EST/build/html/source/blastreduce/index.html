<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BLAST Reduce &mdash; EFI 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=60dbed4a"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Transcode" href="transcode.html" />
    <link rel="prev" title="Enzyme Function Initiative’s Enzyme Similarity Tool" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            EFI
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">BLAST Reduce</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-usage">Example Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technical-details">Technical details</a></li>
<li class="toctree-l2"><a class="reference internal" href="#components">Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="transcode.html">Transcode</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/index.html">Visualization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EFI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">BLAST Reduce</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/source/blastreduce/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="blast-reduce">
<h1>BLAST Reduce<a class="headerlink" href="#blast-reduce" title="Link to this heading"></a></h1>
<p>In this stage, BLAST output shards are collected into a single file.</p>
<p>The previous stage splits the input FASTA file into shards (typically 64) and
distributes the search over the cluster for better performance. Each individual
search produces its own tabular output file. These files represent the complete
output of the all-by-all BLAST.</p>
<p>This stage performs the following operations:</p>
<p>1. <strong>Deduplicate BLAST output</strong>. Because an all-by-all BLAST is run, there may be
multiple copies of pairs of sequence identifiers present in the output. Only one
of these pairs is desired, so this stage removes all but the first occurrence
(smallest when sorted lexicographically by <cite>qseqid</cite> and <cite>sseqid</cite>).</p>
<p>1. <strong>Add sequence length information</strong>. Every <cite>qseqid</cite> and every <cite>sseqid</cite>
represents a sequence from the input FASTA file. The lengths of these
sequences is needed for a later alignment score calculation. This stage
computes sequence lengths and combines this information with the concatenated
BLAST output.</p>
<p>3. <strong>Compute Alignment Score</strong>. The alignment score is computed for each BLAST
entry and stored in the concatenated BLAST output file alongside other
relevant values.</p>
<section id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Link to this heading"></a></h2>
<p>1. Transcode the BLAST output and FASTA file into Parquet files. When both a
BLAST output directory and FASTA file are passed, the SQL template will be
generated.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>python transcode.py --blast-output &lt;job-id&gt;/output/blastout/ --fasta &lt;job-id&gt;/allsequences.fa
</pre></div>
</div>
<p>This will produce <code class="docutils literal notranslate"><span class="pre">.parquet</span></code> versions of the BLAST output (in the same
directory as the BLAST output) and a <code class="docutils literal notranslate"><span class="pre">.parquet</span></code> file containing sequence IDs
and sequence lengths.</p>
<ol class="arabic simple" start="2">
<li><p>Run the generated SQL file</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>duckdb &lt; reduce.sql
</pre></div>
</div>
<p>This will produce a file <cite>1.out.parquet</cite> that contains the processed BLAST output.</p>
</section>
<section id="technical-details">
<h2>Technical details<a class="headerlink" href="#technical-details" title="Link to this heading"></a></h2>
<p>A BLAST output file looks like this (column names added):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>qseqid</p></th>
<th class="head"><p>sseqid</p></th>
<th class="head"><p>pident</p></th>
<th class="head"><p>alignment_length</p></th>
<th class="head"><p>mismatches</p></th>
<th class="head"><p>gap_openings</p></th>
<th class="head"><p>qstart</p></th>
<th class="head"><p>qend</p></th>
<th class="head"><p>sstart</p></th>
<th class="head"><p>send</p></th>
<th class="head"><p>evalue</p></th>
<th class="head"><p>bitscore</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A010NVS6</p></td>
<td><p>100.00</p></td>
<td><p>465</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>465</p></td>
<td><p>1</p></td>
<td><p>465</p></td>
<td><p>0.0</p></td>
<td><p>978</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1VDT6</p></td>
<td><p>68.28</p></td>
<td><p>435</p></td>
<td><p>138</p></td>
<td><p>0</p></td>
<td><p>8</p></td>
<td><p>442</p></td>
<td><p>8</p></td>
<td><p>442</p></td>
<td><p>0.0</p></td>
<td><p>664</p></td>
</tr>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A644ZDI5</p></td>
<td><p>67.27</p></td>
<td><p>440</p></td>
<td><p>144</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>440</p></td>
<td><p>1</p></td>
<td><p>440</p></td>
<td><p>0.0</p></td>
<td><p>658</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1TFA1</p></td>
<td><p>65.32</p></td>
<td><p>444</p></td>
<td><p>154</p></td>
<td><p>0</p></td>
<td><p>8</p></td>
<td><p>451</p></td>
<td><p>10</p></td>
<td><p>453</p></td>
<td><p>0.0</p></td>
<td><p>650</p></td>
</tr>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A354I928</p></td>
<td><p>64.79</p></td>
<td><p>443</p></td>
<td><p>156</p></td>
<td><p>0</p></td>
<td><p>8</p></td>
<td><p>450</p></td>
<td><p>8</p></td>
<td><p>450</p></td>
<td><p>0.0</p></td>
<td><p>649</p></td>
</tr>
</tbody>
</table>
<p>EFI only uses a subset of the columns. Self-matches and duplicates are filtered out:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>qseqid</p></th>
<th class="head"><p>sseqid</p></th>
<th class="head"><p>pident</p></th>
<th class="head"><p>alignment_length</p></th>
<th class="head"><p>bitscore</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1VDT6</p></td>
<td><p>68.28</p></td>
<td><p>435</p></td>
<td><p>664</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A644ZDI5</p></td>
<td><p>67.27</p></td>
<td><p>440</p></td>
<td><p>658</p></td>
</tr>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1TFA1</p></td>
<td><p>65.32</p></td>
<td><p>444</p></td>
<td><p>650</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A354I928</p></td>
<td><p>64.79</p></td>
<td><p>443</p></td>
<td><p>649</p></td>
</tr>
</tbody>
</table>
<p>Then two additional columns are using the associated FASTA file:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>qseqid</p></th>
<th class="head"><p>sseqid</p></th>
<th class="head"><p>pident</p></th>
<th class="head"><p>alignment_length</p></th>
<th class="head"><p>bitscore</p></th>
<th class="head"><p>query_length</p></th>
<th class="head"><p>subject_length</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1VDT6</p></td>
<td><p>68.28</p></td>
<td><p>435</p></td>
<td><p>664</p></td>
<td><p>3672</p></td>
<td><p>2536</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A644ZDI5</p></td>
<td><p>67.27</p></td>
<td><p>440</p></td>
<td><p>658</p></td>
<td><p>263</p></td>
<td><p>1836</p></td>
</tr>
<tr class="row-even"><td><p>A0A010NVS6</p></td>
<td><p>A0A9D1TFA1</p></td>
<td><p>65.32</p></td>
<td><p>444</p></td>
<td><p>650</p></td>
<td><p>1938</p></td>
<td><p>927</p></td>
</tr>
<tr class="row-odd"><td><p>A0A010NVS6</p></td>
<td><p>A0A354I928</p></td>
<td><p>64.79</p></td>
<td><p>443</p></td>
<td><p>649</p></td>
<td><p>1211</p></td>
<td><p>134</p></td>
</tr>
</tbody>
</table>
<p>To make this process fast, the computational steps are as follows:
1. <strong>Transcode BLAST output to Parquet</strong>. Each BLAST output shard is transcoded to
a Parquet file. Unused columns are dropped during the conversion.</p>
<p>2. <strong>Count sequence lengths and store in Parquet</strong>. The input FASTA file is
iterated through and sequence identifiers are stored alongside their
respective lengths in a Parquet file.</p>
<p>3. <strong>Render a SQL file</strong>. A template SQL file is processed to produce a sequence
of SQL commands. This uses Python’s <cite>string.Template</cite> standard library
module.</p>
<p>4. <strong>Execute SQL on BLAST output and FASTA sequence lengths</strong>. The rendered SQL
file is used to deduplicate BLAST output and pair each line with its sequence
counts. DuckDB saves the output in a Parquet file.</p>
</section>
<section id="components">
<h2>Components<a class="headerlink" href="#components" title="Link to this heading"></a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="transcode.html">Transcode</a></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../index.html" class="btn btn-neutral float-left" title="Enzyme Function Initiative’s Enzyme Similarity Tool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="transcode.html" class="btn btn-neutral float-right" title="Transcode" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Enzyme Function Initiative.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>